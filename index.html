<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Geo Summary">
    <meta name="author" content="GoGEO LBS">

    <title>Geo Summary</title>

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <link rel="stylesheet" href="assets/stylesheet/leaflet/leaflet.draw.css" />
    <link rel="stylesheet" href="assets/stylesheet/leaflet/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="assets/stylesheet/leaflet/MarkerCluster.css" />
    <link rel="stylesheet" href="assets/stylesheet/geo-summary.css" />
    <link href="http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">


  </head>
  <body>
    <button id="geosearch-button" class="btn btn-default">
      <i class="fa fa-search"></i>
    </button>

    <div id="map" style="width: auto; height: 800px"></div>

    <div id="geosearch-result-div" class="well">
      <div id="geosearch-result">
        <div class="geosearch-result-title">
          <div class="row">
            <div id="geosearch-result-title-with-qtd" class="col-lg-10">
              <h3>
                Summary <small id="geosearch-result-qtd"></small>
              </h3>
            </div>
          </div>
        </div>
        <div class="geosearch-result-body">
          <div class="row">
            <div class="col-lg-12" style="margin-left: -8px;">
              <table id="geosearch-result-list" style="width:300px">
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script src="assets/javascript/leaflet/leaflet.draw-src.js"></script>
    <script src="assets/javascript/leaflet/leaflet.tilecluster.js"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

    <script type="text/javascript">
      var showDrawbuttons = function() {
        $('.leaflet-draw-actions').remove();
        $('.leaflet-draw-draw-rectangle').animate({'height': '26px'}, {'duration': 200, 'queue': false}, function(){}); 
        $('.leaflet-draw-draw-polygon').animate({'height': '26px'}, {'duration': 200, 'queue': false}, function(){}); 
        $('.leaflet-draw').animate({'top': '0px'}, {'duration': 200, 'queue': false}, function(){}); 
        $('.leaflet-draw').animate({'left': '51px'}, {'duration': 200, 'queue': false}, function(){});
      };

      var hideDrawbuttons = function() {
        $('.leaflet-draw-draw-rectangle').animate({'height': '0px'}, {'duration': 200, 'queue': false}, function(){}); 
        $('.leaflet-draw-draw-polygon').animate({'height': '0px'}, {'duration': 200, 'queue': false}, function(){}); 
        $('.leaflet-draw').animate({'top': '28px'}, {'duration': 200, 'queue': false}, function(){}); 
        $('.leaflet-draw').animate({'left': '3px'}, {'duration': 200, 'queue': false}, function(){});
      };

      var addBaseLayer = function(map) {
        var baseLayer = L.tileLayer('http://{s}.maptile.lbs.ovi.com/maptiler/v2/maptile/newest/normal.day.grey/{z}/{x}/{y}/256/png8?token=gBoUkAMoxoqIWfxWA5DuMQ&app_id=mBCJzriKRMXN-4giYVBc', {
            subdomains: '123',
            maxZoom: 14
        });

        map.addLayer(baseLayer);

        return baseLayer;
      };

      var addCluster = function(clusterUrl, subdomains, group) {
        var options = {
          maxZoom: 18,
          subdomains: subdomains,
          useJsonP: true,
          calculateClusterQtd: function(zoom) {
            if (zoom >= 5) {
              return 2;
            } else {
              return 1;
            }
          }
        };

        cluster = L.tileCluster(clusterUrl, options);
        group.addLayer(cluster);

        return cluster;
      };

      var getAndShowSumary = function() {
        $('#geosearch-result-list').empty();
        var result = {
          shop: Math.floor((Math.random() * 10000) + 1),
          bar: Math.floor((Math.random() * 10000) + 1),
          restaurant: Math.floor((Math.random() * 10000) + 1),
        };

        listHtml = [];
        for (var item in result) {
          var tr = document.createElement('tr'),
              td_cat = document.createElement('td'),
              td_val = document.createElement('td'),
              span_badges = document.createElement('td');

          td_cat.textContent = item;
          
          span_badges.className = "badge";
          span_badges.textContent = result[item];
          td_val.appendChild(span_badges);
          
          tr.appendChild(td_cat);
          tr.appendChild(td_val);
          listHtml.push(tr.outerHTML);
        }
        
        listHtml = listHtml.join('\n');
        $('#geosearch-result-list').append(listHtml);
      };

      var addControls = function(map) {
        editableLayers = new L.FeatureGroup();
        map.addLayer(editableLayers);

        var options = {
          position: 'topleft',
          draw: {
            polyline: false,
            polygon: {
              allowIntersection: false, // Restricts shapes to simple polygons
              drawError: {
                color: '#e1e100'
              },
              shapeOptions: {
                color: '#bada55'
              }
            },
            circle: false, // Turns off this drawing tool
            rectangle: {
              shapeOptions: {
                clickable: true
              }
            },
            marker: false
          },
          edit: false
        };

        var drawControl = new L.Control.Draw(options);
        map.addControl(drawControl);

        map.on('draw:created',
          function(e) {
            var type = e.layerType,
                layer = e.layer;

            editableLayers.addLayer(layer);
            getAndShowSumary();
          }
        );

        map.on('draw:drawstart',
          function(e) {
            editableLayers.clearLayers();
          }
        );
      };

      var initMaps = function() {
        map = L.map('map').setView([-10, -55], 5);
        group = new L.LayerGroup().addTo(map);

        addBaseLayer(map);

        // var clusterUrl = "https://{s}.gogeo.io//map/geo_summary/geo_names/{z}/{x}/{y}/cluster.json?mapkey=141bb3be-619a-4ffd-9aab-664ad92e568e",
        var clusterUrl = "https://{s}.gogeo.io/map/databases/gdelt3/{z}/{x}/{y}/cluster.json?mapkey=c5b8c3ca-2e80-46bf-bf51-aa74101c46bb&callback={cb}",
            subdomains = ["m1","m2","m3"];
        
        addCluster(clusterUrl, subdomains, group);
        addControls(map);
      };

      initMaps();
      $('.leaflet-draw-draw-rectangle').css('height', '0px');

      $(document).on('click', '#geosearch-button',
        function() {
          var height = $('.leaflet-draw-draw-rectangle').css('height');
          
          if (height === '0px') {
            showDrawbuttons();
          } else {
            hideDrawbuttons();
          }
        }
      );
    </script>
  </body>
</html>